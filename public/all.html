<!DOCTYPE html>
<html>
<head>
  <title>Item列表</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Key</th>
        <th>Value</th>
        <th>Created At</th>
        <th>Updated At</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="itemTableBody"></tbody>
  </table>

  <button id="deleteSelectedButton" disabled>批量删除</button>

  <script>
    const apiUrl = 'https://quna.cf/api/url/';
    const deleteUrl = 'https://quna.cf/api/url/';

    // 使用fetch函数获取item数据
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        const itemTableBody = document.getElementById('itemTableBody');

        // 遍历item数组并创建表格行
        data.forEach(item => {
          const row = document.createElement('tr');

          // 创建复选框
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.addEventListener('change', () => {
            updateDeleteSelectedButtonState();
          });

          const checkboxCell = document.createElement('td');
          checkboxCell.appendChild(checkbox);
          row.appendChild(checkboxCell);

          // 创建单元格并填充数据
          const keyCell = document.createElement('td');
          keyCell.textContent = item.key;
          row.appendChild(keyCell);

          const valueCell = document.createElement('td');
          valueCell.textContent = item.value;
          row.appendChild(valueCell);

          const createdAtCell = document.createElement('td');
          createdAtCell.textContent = item.createdAt;
          row.appendChild(createdAtCell);

          const updatedAtCell = document.createElement('td');
          updatedAtCell.textContent = item.updatedAt;
          row.appendChild(updatedAtCell);

          // 创建删除按钮
          const deleteButton = document.createElement('button');
          deleteButton.textContent = '删除';
          deleteButton.addEventListener('click', () => {
            const confirmDelete = confirm('确定要删除这个item吗？');
            if (confirmDelete) {
              deleteItem(item.key);
            }
          });

          const deleteCell = document.createElement('td');
          deleteCell.appendChild(deleteButton);
          row.appendChild(deleteCell);

          // 将行添加到表格主体
          itemTableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error:', error);
      });

    // 删除item
    function deleteItem(key) {
      const deleteData = {
        keys: [key]
      };

      fetch(deleteUrl, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(deleteData)
      })
        .then(response => {
          if (response.ok) {
            alert('删除成功！');
            location.reload(); // 刷新页面以更新表格
          } else {
            throw new Error('删除失败！');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    // 更新批量删除按钮的状态
    function updateDeleteSelectedButtonState() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const deleteSelectedButton = document.getElementById('deleteSelectedButton');

      let isAnyCheckboxChecked = false;
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          isAnyCheckboxChecked = true;
        }
      });

      deleteSelectedButton.disabled = !isAnyCheckboxChecked;
    }

    // 批量删除选中的item
    function deleteSelectedItems() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const keys = [];

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const key = checkbox.parentElement.nextElementSibling.textContent;
          keys.push(key);
        }
      });

      const deleteData = {
        keys: keys
      };

      fetch(deleteUrl, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(deleteData)
      })
        .then(response => {
          if (response.ok) {
            alert('批量删除成功！');
            location.reload(); // 刷新页面以更新表格
          } else {
            throw new Error('批量删除失败！');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    const deleteSelectedButton = document.getElementById('deleteSelectedButton');
    deleteSelectedButton.addEventListener('click', deleteSelectedItems);
  </script>
</body>
</html>
